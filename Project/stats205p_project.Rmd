---
title: "STATS205P_Project"
author: "Chuqi Wang"
date: "2024-06-12"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rstan)
library(rstan)
getwd()
data = read.csv("healthcare-dataset-stroke-data.csv", header = TRUE, 
                       na.strings = c("N/A", "NA", ""))
summary(data)
```

```{r}
head(data)
dim(data)
names(data)
```


```{r}
library(dplyr)
data %>% summarise_all(~sum(is.na(.)))
```

```{r}
data$bmi[is.na(data$bmi)] <- median(data$bmi, na.rm = TRUE)
```

```{r}
# Load necessary libraries
# Load necessary libraries
library(ggplot2)
library(gridExtra)
library(grid)
# Create a density plot for age
p1 <- ggplot(data, aes(x = age)) +
  geom_density(fill = "blue", alpha = 0.5) +
  theme_minimal() +
  labs(title = "Density Plot of Age", x = "Age", y = "Density") +
  theme(plot.title = element_text(size = 15),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10))

# Create a density plot for BMI
p2 <- ggplot(data, aes(x = bmi)) +
  geom_density(fill = "green", alpha = 0.5) +
  theme_minimal() +
  labs(title = "Density Plot of BMI", x = "BMI", y = "Density") +
  theme(plot.title = element_text(size = 15),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10))

# Create a density plot for average glucose level
p3 <- ggplot(data, aes(x = avg_glucose_level)) +
  geom_density(fill = "purple", alpha = 0.5) +
  theme_minimal() +
  labs(title = "Density Plot of Average Glucose Level", x = "Average Glucose Level", y = "Density") +
  theme(plot.title = element_text(size = 15),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10))

# Box plot for age by stroke status
p4 <- ggplot(data, aes(x = factor(stroke), y = age)) +
  geom_boxplot(fill = "blue", alpha = 0.5) +
  theme_minimal() +
  labs(title = 'Age by Stroke Status', x = 'Stroke', y = 'Age') +
  theme(plot.title = element_text(size = 15),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10))

# Box plot for bmi by stroke status
p5 <- ggplot(data, aes(x = factor(stroke), y = bmi)) +
  geom_boxplot(fill = "green", alpha = 0.5) +
  theme_minimal() +
  labs(title = 'BMI by Stroke Status', x = 'Stroke', y = 'BMI') +
  theme(plot.title = element_text(size = 15),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10))

# Box plot for avg_glucose_level by stroke status
p6 <- ggplot(data, aes(x = factor(stroke), y = avg_glucose_level)) +
  geom_boxplot(fill = "purple", alpha = 0.5) +
  theme_minimal() +
  labs(title = 'Average Glucose Level by Stroke Status', x = 'Stroke', y = 'Average Glucose Level') +
  theme(plot.title = element_text(size = 15),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10))

# Scatter plot for age vs stroke
p7 <- ggplot(data, aes(x = age, y = stroke)) +
  geom_jitter(color = "blue", alpha = 0.5) +
  theme_minimal() +
  labs(title = 'Age vs Stroke', x = 'Age', y = 'Stroke') +
  theme(plot.title = element_text(size = 15),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10))

# Scatter plot for bmi vs stroke
p8 <- ggplot(data, aes(x = bmi, y = stroke)) +
  geom_jitter(color = "green", alpha = 0.5) +
  theme_minimal() +
  labs(title = 'BMI vs Stroke', x = 'BMI', y = 'Stroke') +
  theme(plot.title = element_text(size = 15),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10))

# Scatter plot for avg_glucose_level vs stroke
p9 <- ggplot(data, aes(x = avg_glucose_level, y = stroke)) +
  geom_jitter(color = "purple", alpha = 0.5) +
  theme_minimal() +
  labs(title = 'Average Glucose Level vs Stroke', x = 'Average Glucose Level', y = 'Stroke') +
  theme(plot.title = element_text(size = 15),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10))

# Combine the three plots into one layout with increased figure size
grid.arrange(p1, p4, p7, p2, p5, p8, p3, p6, p9, ncol = 3, nrow = 3, 
             top = textGrob("Combined Plots of Age, BMI, and Average Glucose Level by Stroke Status", 
                            gp = gpar(fontsize = 20)))

```

```{r}
# Create a bar plot for gender
p1 <- ggplot(data, aes(x = gender)) +
  geom_bar(aes(fill = gender), color = "black") +
  theme_minimal() +
  labs(title = "Gender", x = "Gender", y = "Count") +
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5) +
  theme(plot.title = element_text(size = 15, face = "bold", color = "navy"),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10, angle = 45, hjust = 1))

# Create a bar plot for hypertension
p2 <- ggplot(data, aes(x = factor(hypertension))) +
  geom_bar(aes(fill = factor(hypertension)), color = "black") +
  theme_minimal() +
  labs(title = "Hypertension", x = "Hypertension", y = "Count") +
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5) +
  theme(plot.title = element_text(size = 15, face = "bold", color = "navy"),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10, angle = 45, hjust = 1))

# Create a bar plot for heart_disease
p3 <- ggplot(data, aes(x = factor(heart_disease))) +
  geom_bar(aes(fill = factor(heart_disease)), color = "black") +
  theme_minimal() +
  labs(title = "Heart Disease", x = "Heart Disease", y = "Count") +
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5) +
  theme(plot.title = element_text(size = 15, face = "bold", color = "navy"),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10, angle = 45, hjust = 1))

# Create a bar plot for ever_married
p4 <- ggplot(data, aes(x = ever_married)) +
  geom_bar(aes(fill = ever_married), color = "black") +
  theme_minimal() +
  labs(title = "Ever Married", x = "Ever Married", y = "Count") +
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5) +
  theme(plot.title = element_text(size = 15, face = "bold", color = "navy"),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10, angle = 45, hjust = 1))

# Create a bar plot for work_type
p5 <- ggplot(data, aes(x = work_type)) +
  geom_bar(aes(fill = work_type), color = "black") +
  theme_minimal() +
  labs(title = "Work Type", x = "Work Type", y = "Count") +
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5) +
  theme(plot.title = element_text(size = 15, face = "bold", color = "navy"),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10, angle = 45, hjust = 1))

# Create a bar plot for Residence_type
p6 <- ggplot(data, aes(x = Residence_type)) +
  geom_bar(aes(fill = Residence_type), color = "black") +
  theme_minimal() +
  labs(title = "Residence Type", x = "Residence Type", y = "Count") +
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5) +
  theme(plot.title = element_text(size = 15, face = "bold", color = "navy"),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10, angle = 45, hjust = 1))

# Create a bar plot for smoking_status
p7 <- ggplot(data, aes(x = smoking_status)) +
  geom_bar(aes(fill = smoking_status), color = "black") +
  theme_minimal() +
  labs(title = "Smoking Status", x = "Smoking Status", y = "Count") +
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5) +
  theme(plot.title = element_text(size = 15, face = "bold", color = "navy"),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10, angle = 45, hjust = 1))

# Create a bar plot for stroke
p8 <- ggplot(data, aes(x = factor(stroke))) +
  geom_bar(aes(fill = factor(stroke)), color = "black") +
  theme_minimal() +
  labs(title = "Stroke", x = "Stroke", y = "Count") +
  geom_text(stat = 'count', aes(label = ..count..), vjust = -0.5) +
  theme(plot.title = element_text(size = 15, face = "bold", color = "navy"),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10, angle = 45, hjust = 1))
# Combine the bar plots into one layout
grid.arrange(p1, p2, p3, p4, ncol = 2, nrow = 2)
grid.arrange(p5, p6, p7, p8, ncol = 2, nrow = 2)
```



```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)

# Prepare the data
stroke_data <- data %>%
  group_by(stroke) %>%
  summarise(count = n()) %>%
  mutate(prop = count / sum(count) * 100,
         label = paste0(round(prop, 1), "%"))

# Create the pie chart with percentage labels
pie_chart <- ggplot(stroke_data, aes(x = "", y = prop, fill = factor(stroke))) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar(theta = "y") +
  labs(title = "Pie Chart of Stroke Distribution", fill = "Stroke") +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_blank(),
        plot.title = element_text(size = 18, face = "bold"),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12)) +
  geom_text(aes(label = label), position = position_stack(vjust = 0.5), size = 4)

# Display the pie chart
print(pie_chart)

```

```{r}
# Density plot for age
p1 = ggplot(data, aes(x = age, fill = factor(stroke))) +
  geom_density(alpha = 0.5) +
  theme_minimal() +
  labs(title = 'Age Density Plot', x = 'Age', y = 'Density', fill = 'Stroke') +
  scale_fill_manual(values = c("0" = "black", "1" = "red"))

# Density plot for bmi
p2 = ggplot(data, aes(x = bmi, fill = factor(stroke))) +
  geom_density(alpha = 0.5) +
  theme_minimal() +
  labs(title = 'BMI Density Plot', x = 'BMI', y = 'Density', fill = 'Stroke') +
  scale_fill_manual(values = c("0" = "black", "1" = "red"))

# Density plot for avg_glucose_level
p3 = ggplot(data, aes(x = avg_glucose_level, fill = factor(stroke))) +
  geom_density(alpha = 0.5) +
  theme_minimal() +
  labs(title = 'Average Glucose Level Density Plot', x = 'Average Glucose Level', y = 'Density', fill = 'Stroke') +
  scale_fill_manual(values = c("0" = "black", "1" = "red"))

grid.arrange(p1, p2, p3, ncol = 1, nrow = 3)
```
```{r}
library(caret)
data <- data %>%
  mutate(gender = as.factor(gender),
         ever_married = as.factor(ever_married),
         work_type = as.factor(work_type),
         Residence_type = as.factor(Residence_type),
         smoking_status = as.factor(smoking_status))
set.seed(123)  # For reproducibility
train_index <- createDataPartition(data$stroke, p = 0.8, list = FALSE)
train_data <- data[train_index, ]
test_data <- data[-train_index, ]
# Check the dimensions of the split data
dim(train_data)
dim(test_data)
```

```{r}
library(brms)
priors <- c(set_prior("normal(0, 10)", class = "b"),  # Prior for coefficients
            set_prior("student_t(3, 0, 10)", class = "Intercept"))  # Prior for intercept
formula <- bf(stroke ~ gender + age + hypertension + heart_disease + ever_married +
              work_type + Residence_type + avg_glucose_level + bmi + smoking_status,
              family = bernoulli())

# Fit the model
fit <- brm(formula, data = train_data, prior = priors, iter = 2000, chains = 4, seed = 123)
```
```{r}
summary(fit)
```

```{r}
predictions <- predict(fit, newdata = test_data, type = "response")

# Convert probabilities to binary predictions
test_data$predicted_stroke <- ifelse(predictions[,1] > 0.5, 1, 0)

# Evaluate the model
conf_matrix <- table(test_data$stroke, test_data$predicted_stroke)
accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
cat("Accuracy:", accuracy, "\n")
print(conf_matrix)
```
```{r}
library(bayesplot)
mcmc_trace(as.mcmc(fit)) + ggtitle("Trace Plots for Model Parameters") + theme_minimal()
```



```{r}

# Create individual plots for each parameter
g1 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_Intercept"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of the Intercept") +
  xlab("Intercept") +
  ylab("Density") +
  theme_minimal()

g2 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_genderMale"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of genderMale") +
  xlab("genderMale") +
  ylab("Density") +
  theme_minimal()

g3 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_genderOther"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of genderOther") +
  xlab("genderOther") +
  ylab("Density") +
  theme_minimal()

# Continue for other parameters
g4 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_age"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of age") +
  xlab("age") +
  ylab("Density") +
  theme_minimal()

g5 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_hypertension"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of hypertension1") +
  xlab("hypertension") +
  ylab("Density") +
  theme_minimal()

g6 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_heart_disease"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of heart_disease1") +
  xlab("heart_disease") +
  ylab("Density") +
  theme_minimal()

g7 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_ever_marriedYes"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of ever_marriedYes") +
  xlab("ever_marriedYes") +
  ylab("Density") +
  theme_minimal()

g8 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_work_typeGovt_job"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of work_typeGovt_job") +
  xlab("work_typeGovt_job") +
  ylab("Density") +
  theme_minimal()

g9 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_work_typeNever_worked"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of work_typeNever_worked") +
  xlab("work_typeNever_worked") +
  ylab("Density") +
  theme_minimal()

g10 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_work_typePrivate"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of work_typePrivate") +
  xlab("work_typePrivate") +
  ylab("Density") +
  theme_minimal()

g11 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_work_typeSelfMemployed"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of work_typeSelfEmployed") +
  xlab("work_typeSelfEmployed") +
  ylab("Density") +
  theme_minimal()

g12 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_Residence_typeUrban"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of Residence_typeUrban") +
  xlab("Residence_typeUrban") +
  ylab("Density") +
  theme_minimal()

g13 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_avg_glucose_level"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of avg_glucose_level") +
  xlab("avg_glucose_level") +
  ylab("Density") +
  theme_minimal()

g14 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_bmi"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of bmi") +
  xlab("bmi") +
  ylab("Density") +
  theme_minimal()

g15 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_smoking_statusneversmoked"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of smoking_statusneversmoked") +
  xlab("smoking_statusneversmoked") +
  ylab("Density") +
  theme_minimal()

g16 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_smoking_statussmokes"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of smoking_statussmokes") +
  xlab("smoking_statussmokes") +
  ylab("Density") +
  theme_minimal()

g17 <- mcmc_areas(
  as.mcmc(fit),
  pars = c("b_smoking_statusUnknown"),
  prob = 0.95
) + 
  ggtitle("Posterior Distribution of smoking_statusUnknown") +
  xlab("smoking_statusUnknown") +
  ylab("Density") +
  theme_minimal()

# Combine all plots into a grid
grid.arrange(g1, g2, g3, g4, g5, g6, g7, g8, g9, g10, g11, g12, g13, g14, g15, g16, g17, ncol = 3)

```


```{r}
predictions <- predict(fit, newdata = test_data, type = "response")

# Convert probabilities to binary predictions
test_data$predicted_stroke <- ifelse(predictions[,1] > 0.3, 1, 0)

# Evaluate the model
conf_matrix <- table(test_data$stroke, test_data$predicted_stroke)
accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
cat("Accuracy:", accuracy, "\n")
print(conf_matrix)
```

```{r}
# Load necessary libraries
library(brms)
library(dplyr)

# Assuming 'fit' is your fitted model object
# and 'train_data' is your training dataset

# Generate posterior predictions for the training data
y_rep_train <- posterior_predict(fit, newdata = train_data)

# Calculate the mean predicted probability across the posterior samples
predicted_probs_train <- apply(y_rep_train, 2, mean)

# Set a threshold for stroke prediction (e.g., 0.5)
threshold <- 0.25

# Classify the individual based on the predicted probability
predicted_class_train <- ifelse(predicted_probs_train > threshold, 1, 0)

# Create a confusion matrix
confusion_matrix_train <- table(train_data$stroke, predicted_class_train)
print(confusion_matrix_train)

# Calculate training accuracy
training_accuracy <- sum(diag(confusion_matrix_train)) / sum(confusion_matrix_train)
print(paste("Training Accuracy:", training_accuracy))

```


```{r}
# Create a data frame for the individual
individual_data <- data.frame(
  gender = "Male",
  age = 68,
  hypertension = 0,
  heart_disease = 1,
  ever_married = "Yes",
  work_type = "Private",
  Residence_type = "Urban",
  avg_glucose_level = 229,
  bmi = 36,
  smoking_status = "formerly smoked"
)

# Ensure the levels of categorical variables match the training data
individual_data$gender <- factor(individual_data$gender, levels = levels(train_data$gender))
individual_data$ever_married <- factor(individual_data$ever_married, levels = levels(train_data$ever_married))
individual_data$work_type <- factor(individual_data$work_type, levels = levels(train_data$work_type))
individual_data$Residence_type <- factor(individual_data$Residence_type, levels = levels(train_data$Residence_type))
individual_data$smoking_status <- factor(individual_data$smoking_status, levels = levels(train_data$smoking_status))

```


```{r}
# Generate posterior predictions for the individual
predicted_probs <- posterior_predict(fit, newdata = individual_data)

# Calculate the mean predicted probability across the posterior samples
predicted_prob <- mean(predicted_probs)

# Print the predicted probability
print(predicted_prob)

```

```{r}
# Define a threshold for classification (e.g., 0.5)
threshold <- 0.5

# Classify the individual based on the predicted probability
predicted_class <- ifelse(predicted_prob > threshold, 1, 0)

# Print the predicted class
if(predicted_class == 1) {
  cat("The model predicts that the individual is at risk of having a stroke.\n")
} else {
  cat("The model predicts that the individual is not at risk of having a stroke.\n")
}
```


```{r}
# Load necessary libraries
library(brms)
library(dplyr)

# Assuming 'fit' is your fitted model object
# and 'test_data' is your test dataset

# Generate posterior predictions for the test data
y_rep_test <- posterior_predict(fit, newdata = test_data)

# Calculate the mean predicted probability across the posterior samples
predicted_probs <- apply(y_rep_test, 2, mean)

# Define a list of thresholds
thresholds <- seq(0.1, 0.9, by = 0.01)

# Initialize a vector to store accuracy results
accuracies <- numeric(length(thresholds))

# Loop through each threshold and calculate accuracy
for (i in seq_along(thresholds)) {
  threshold <- thresholds[i]
  predicted_class <- ifelse(predicted_probs > threshold, 1, 0)
  confusion_matrix <- table(test_data$stroke, predicted_class)
  
  # Calculate accuracy
  accuracy <- sum(diag(confusion_matrix)) / sum(confusion_matrix)
  accuracies[i] <- accuracy
}

# Combine thresholds and accuracies into a data frame
results <- data.frame(Threshold = thresholds, Accuracy = accuracies)

# Print the results
print(results)

# Optionally, plot the results
library(ggplot2)
ggplot(results, aes(x = Threshold, y = Accuracy)) +
  geom_line() +
  geom_point() +
  ggtitle("Accuracy vs. Threshold") +
  xlab("Threshold") +
  ylab("Accuracy") +
  theme_minimal()

```

```{r}

# Load necessary libraries
library(brms)
library(pROC)

# Assuming 'fit' is your fitted model object
# and 'test_data' is your test dataset

# Generate posterior predictions for the test data
y_rep_test <- posterior_predict(fit, newdata = test_data)

# Calculate the mean predicted probability across the posterior samples
predicted_probs <- apply(y_rep_test, 2, mean)

# Calculate the ROC curve and AUC
roc_obj <- roc(test_data$stroke, predicted_probs)

# Print the AUC value
auc_value <- auc(roc_obj)
print(paste("ROC-AUC:", auc_value))

# Plot the ROC curve
plot(roc_obj, main = paste("ROC Curve (AUC =", round(auc_value, 2), ")"))

```

